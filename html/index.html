<style>
  .formio-form>div>nav {
    display: none;
  }

  .lb p button {
    margin-right: 5px;
  }
</style>

<script src="https://unpkg.com/formiojs@latest/dist/formio.full.min.js"></script>

<div id="formio" class="lb"></div>

<div class="button-container lb"></div>

<script type="text/javascript">
  /**
   * @class LabelBuster
   */
  const formLocation = 'https://api.forms.platforms.qld.gov.au/fesrqwsyzlbtegd/formwizard';
  class LabelBuster {
    /**
     * @param {Boolean} test if we are running a test
     * @returns {void}
     */
    constructor(test = false) {
      this.formLocation = formLocation;
      this.formElement = {};
      this.formSettings = {
        buttonSettings: {
          showCancel: false,
          showPrevious: false,
          showNext: false,
          showSubmit: false,
        },
      };
      this.wizard = {};
      this.loaded = false;
      this.isTest = test;

      window.addEventListener('DOMContentLoaded', () => {
        if (this.isTest) return;
        this.initialise();
      });

      window.addEventListener('labelbusterGoToNext', () => {
        this.goToNextPage();
      });

      window.addEventListener('labelbusterAccept', () => {
        this.acceptEvent();
      });

      window.addEventListener('labelbusterGoToPrevious', () => {
        this.goToPreviousPage();
      });

      window.addEventListener('labelbusterCancel', () => {
        this.goToPage(0);
      });
    }

    /**
     */
    initialise() {
      this.formElement = document.querySelector('#formio');
      Formio.createForm(
        this.formElement,
        this.formLocation,
        this.formSettings,
      ).then((wizard) => {
        this.wizard = wizard;
        this.loaded = true;
      });
      this.firePageChangeEvent();
    }

    /**
     * @returns {void}
    */
    firePageChangeEvent() {
      const event = new CustomEvent('labelbusterPageChange', {
        bubbles: true,
        detail: {
          page: this.wizard && this.wizard.page ? this.wizard.page : 0,
        },
      });
      window.dispatchEvent(event);
    }

    /**
     * @return {Boolean}
     */
    goToNextPage() {
      if (!this.loaded) {
        this.notLoaded();
        return false;
      }
      if (this.isTest) {
        return true;
      }
      this.wizard.nextPage().then(() => {
        this.firePageChangeEvent();
      });
      return true;
    }

    /**
     * @return {Boolean}
     */
    acceptEvent() {
      if (!this.loaded) {
        this.notLoaded();
        return false;
      }
      if (!this.hasAccepted()) return false;
      if (this.isTest) {
        return true;
      }
      this.wizard.nextPage().then(() => {
        this.firePageChangeEvent();
      });
      return true;
    }

    /**
     * @return {Boolean}
     */
    hasAccepted() {
      return this.wizard._data.termsAndConditions;
    }

    /**
     * @return {Boolean}
     */
    goToPreviousPage() {
      if (!this.loaded) {
        this.notLoaded();
        return false;
      }
      if (this.isTest) {
        return true;
      }
      this.wizard.prevPage().then(() => {
        this.firePageChangeEvent();
      });
      return true;
    }

    /**
     * @return {Boolean}
     */
    goToPage(pageNo) {
      if (!this.loaded) {
        this.notLoaded();
        return false;
      }
      if (this.isTest) {
        return true;
      }
      this.wizard.setPage(pageNo).then(() => {
        this.firePageChangeEvent();
      });
      return true;
    }

    notLoaded() {
      const errorObject = {
        element: this.formElement,
        loaded: this.loaded,
        settings: this.settings,
        name: 'Loaded Exception',
        message: 'FormIO not properly loaded',
      };

      throw errorObject;
    }
  }

  window.label = new LabelBuster();

  /**
   * Render a button
   * @param {String} text the button's inner text
   * @param {String} eventName the custom event that button will fire
   * @param {String} cssClass the class that describes the presentation of the button
   * @returns {HTMLButtonElement}
   */
  function button(text, eventName, cssClass) {
    const _button = document.createElement('button');
    _button.innerText = text;
    _button.className = `qg-btn ${cssClass}`;
    _button.addEventListener('click', e => fireEvent(e, eventName));
    return _button;
  }

  /**
   * @param {Event} domEvent the element's event
   * @param {String} name the name of the custom event
   * @returns {void}
   */
  function fireEvent(domEvent, name) {
    const customEvent = new Event(name, { bubbles: true });
    domEvent.target.dispatchEvent(customEvent);
  }

  function buttonGroup(buttons) {
    const container = document.createElement('div');
    container.className = 'panel-body';
    const p = document.createElement('p');

    if (buttons.length > 0) {
      buttons.forEach((buttonConfig) => {
        const { text, eventName, cssClass } = buttonConfig;
        const buttonElement = button(text, eventName, cssClass);
        p.appendChild(buttonElement);
      });
    }
    container.appendChild(p);
    return container;
  }

  /**
   * @class ButtonGroup
   */
  class ButtonGroup {
    constructor(target) {
      this.target = target; // <div class="button-group"></div>
      this.updateTarget(this.render());

      window.addEventListener('labelbusterPageChange', ({ detail: { page } }) => {
        this.updateTarget(this.render(page));
      });
    }

    /**
     * @param {HTMLElement}
     */
    updateTarget(result) {
      this.target.innerHTML = '';
      this.target.appendChild(result);
    }

    /**
     * @param {Number} pageNo the page number provided by the wizard instance
     */
    // eslint-disable-next-line class-methods-use-this
    render(pageNo) {
      if (pageNo === 0) {
        return buttonGroup([
          {
            text: 'Start now',
            eventName: 'labelbusterGoToNext',
            cssClass: 'btn-primary',
          },
        ]);
      }
      if (pageNo === 1) {
        return buttonGroup([
          {
            text: 'Back',
            eventName: 'labelbusterGoToPrevious',
            cssClass: 'btn-default',
          },
          {
            text: 'Accept',
            eventName: 'labelbusterAccept',
            cssClass: 'btn-primary',
          },
          {
            text: 'Cancel',
            eventName: 'labelbusterCancel',
            cssClass: 'btn-link',
          },
        ]);
      }
      return buttonGroup(
        [
          {
            text: 'Back',
            eventName: 'labelbusterGoToPrevious',
            cssClass: 'btn-default',
          },
          {
            text: 'Next',
            eventName: 'labelbusterAccept',
            cssClass: 'btn-primary',
          },
          {
            text: 'Cancel',
            eventName: 'labelbusterCancel',
            cssClass: 'btn-link',
          },
        ],
      );
    }
  }

  new ButtonGroup(
    document.querySelector('.button-container'),
  );
</script>

<script>
  /* remove Squiz rendered H1 in favour of H1 for each view from Form.io */
  document
    .querySelector('#qg-primary-content')
    .removeChild(document.querySelector('h1'));
</script>