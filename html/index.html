<script src="https://unpkg.com/formiojs@latest/dist/formio.full.min.js"></script>

<div id="formio" class="lb"></div>

<div class="button-container"></div>

<script type="text/javascript">
  /**
   * @returns {TemplateString}
   */
  function firePageChangeEvent() {
    const event = new CustomEvent('labelbusterPageChange', {
      bubbles: true, data: {
        page: this.wizard.page ? this.wizard.page : 0,
      },
    });
    window.dispatchEvent(event);
  }

  /**
   * @class LabelBuster
   */
  const formLocation =
    'https://api.forms.platforms.qld.gov.au/fesrqwsyzlbtegd/formwizard';
  class LabelBuster {
    /**
     * @param {Boolean} test if we are running a test
     * @returns {void}
     */
    constructor(test = false) {
      this.formLocation = formLocation;
      this.formElement = {};
      this.formSettings = {
        buttonSettings: {
          showCancel: false,
          showPrevious: false,
          showNext: false,
          showSubmit: false,
        },
      };
      this.wizard = {};
      this.loaded = false;
      this.isTest = test;

      window.addEventListener('DOMContentLoaded', () => {
        if (this.isTest) return;
        this.initialise();
      });

      window.addEventListener('labelbusterGoToNext', () => {
        this.goToNextPage();
      });

      window.addEventListener('labelbusterAccept', () => {
        this.acceptEvent();
      });

      window.addEventListener('labelbusterGoToPrevious', () => {
        this.goToPreviousPage();
      });

      window.addEventListener('labelbusterCancel', () => {
        this.goToPage(0);
      })


    }
    /**
     */
    initialise() {
      this.formElement = document.querySelector('#formio');
      Formio.createForm(
        this.formElement,
        this.formLocation,
        this.formSettings
      ).then(wizard => {
        this.wizard = wizard;
        this.loaded = true;
      });
      firePageChangeEvent();
    }

    /**
     * @return {Boolean}
     */
    goToNextPage() {
      if (!this.loaded) {
        this.notLoaded();
        return false;
      }
      if (this.isTest) {
        return true;
      }
      this.wizard.nextPage().then(() => {
        firePageChangeEvent();
      });
      return true;
    }

    /**
     * @return {Boolean}
     */
    acceptEvent() {
      if (!this.loaded) {
        this.notLoaded();
        return false;
      }
      if (!this.wizard._data.termsAndConditions) return false;
      if (this.isTest) {
        return true;
      }
      this.wizard.nextPage().then(() => {
        firePageChangeEvent();
      });
      return true;
    }

    /**
     * @return {Boolean}
     */
    goToPreviousPage() {
      if (!this.loaded) {
        this.notLoaded();
        return false;
      }
      if (this.isTest) {
        return true;
      }
      this.wizard.prevPage().then(() => {
        firePageChangeEvent();
      });
      return true;
    }

    /**
     */
    goToPage(pageNo) {
      console.log("PageNum", pageNo);
      if (!this.loaded) {
        this.notLoaded();
        return false;
      }
      if (this.isTest) {
        return true;
      }
      this.wizard.setPage(pageNo).then(() => {
        firePageChangeEvent();
      })
      return true;
    }


    notLoaded() {
      const errorObject = {
        element: this.formElement,
        loaded: this.loaded,
        settings: this.settings,
        name: 'Loaded Exception',
        message: 'FormIO not properly loaded',
      };

      throw errorObject;
    }
  }

  window.label = new LabelBuster();

  /**
   * Render a button
   * @param {String} text the button's inner text
   * @param {function} handler the handler the button should fire on click
   * @param {Boolean} isPrimary indicates whether button is primary
   * @returns {TemplateString}
   */
  function button(text, handler, isPrimary = false) {
    const _button = document.createElement('button');
    _button.innerText = text;
    _button.className = `qg-btn ${isPrimary ? 'btn-primary' : 'btn-default'}`;
    _button.addEventListener('click', handler);
    return _button;
  }

  function anchor(text, handler) {
    const _anchor = document.createElement('a');
    _anchor.innerText = text;
    _anchor.addEventListener('click', handler);
    _anchor.setAttribute("href", _anchor);
    return _anchor;
  }

  /**
   * @param {Event} domEvent the element's event
   * @param {String} name the name of the custom event
   * @returns {void}
   */
  function fireEvent(domEvent, name) {
    const customEvent = new Event(name, { bubbles: true });
    domEvent.target.dispatchEvent(customEvent);
  }

  // to do - parameterise the function to accept different configurations of the button group. Array of button objects.
  function buttonGroup(buttons) {
    // const container = document.createElement('div');
    // const previous = button('Back', e =>
    //   fireEvent(e, 'labelbusterGoToPrevious')
    // );
    // const next = button('Next', e => fireEvent(e, 'labelbusterGoToNext'), true);
    // const cancel = anchor(
    //   'Cancel',
    //   e => fireEvent(e, 'labelbusterCancel')
    // );
    // container.appendChild(previous);
    // container.appendChild(next);
    // container.appendChild(cancel);
    // return container;
    const container = document.createElement('div');
    if (buttons.length > 0) buttons.forEach((buttonConfig) => {
      let { text, primary } = buttonConfig;
      let buttonElement = button(text, null, primary);
      container.appendChild(buttonElement);
    })
    return container;
  }


  class ButtonGroup {
    constructor(target) {
      this.target = target;
      this.target.appendChild(this.render());

      window.addEventListener('labelbusterPageChange', ({ data }) => {
        this.target = this.render(data.page);
      });
    }

    render(pageNo) {
      if (pageNo === 1) {
        return buttonGroup([{ text: "Start now", primary: true }]);
      }
      if (pageNo === 2) {
        return buttonGroup([{ text: "Accept", primary: true }, { text: "Back", primary: false }, { text: "Cancel" }]);
      }
      return buttonGroup();
    }
  }

  window.buttonGroup = new ButtonGroup(
    document.querySelector('.button-container')
  );

</script>

<style>
  .formio-form>div>nav {
    display: none;
  }
</style>
<script>
  /* remove Squiz rendered H1 in favour of H1 for each view from Form.io */
  document
    .querySelector('#qg-primary-content')
    .removeChild(document.querySelector('h1'));
</script>